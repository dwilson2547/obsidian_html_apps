<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Regex Extractor</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #181a23;
    --surface-2: #1e2130;
    --border: #2a2d3e;
    --border-focus: #5b6eef;
    --text: #e1e4ed;
    --text-dim: #6b7194;
    --accent: #5b6eef;
    --accent-glow: rgba(91, 110, 239, 0.15);
    --match-bg: rgba(91, 110, 239, 0.18);
    --match-border: rgba(91, 110, 239, 0.5);
    --group-bg: rgba(45, 212, 140, 0.15);
    --group-border: rgba(45, 212, 140, 0.5);
    --warn: #e6a740;
    --warn-bg: rgba(230, 167, 64, 0.12);
    --error: #ef5b5b;
    --error-bg: rgba(239, 91, 91, 0.1);
    --mono: 'IBM Plex Mono', monospace;
    --sans: 'DM Sans', sans-serif;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
    padding: 2rem;
  }

  .container { max-width: 1100px; margin: 0 auto; }

  header {
    display: flex;
    align-items: baseline;
    gap: 1rem;
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 1px solid var(--border);
  }

  h1 {
    font-family: var(--mono);
    font-size: 1.25rem;
    font-weight: 600;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--accent), #8b6eef);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  header .tag {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-dim);
    background: var(--surface);
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    border: 1px solid var(--border);
  }

  /* ── Regex Bar ── */
  .regex-bar {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
    align-items: stretch;
  }

  .regex-input-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0 1rem;
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .regex-input-wrap:focus-within {
    border-color: var(--border-focus);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }

  .regex-input-wrap.error {
    border-color: var(--error);
    box-shadow: 0 0 0 3px var(--error-bg);
  }

  .regex-slash {
    font-family: var(--mono);
    font-size: 1.1rem;
    color: var(--text-dim);
    user-select: none;
  }

  #regexInput {
    flex: 1;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.95rem;
    padding: 0.85rem 0.5rem;
  }

  #regexInput::placeholder { color: var(--text-dim); opacity: 0.5; }

  .flags-wrap {
    display: flex;
    gap: 2px;
    align-items: center;
    margin-left: 0.25rem;
  }

  .flag-btn {
    font-family: var(--mono);
    font-size: 0.8rem;
    font-weight: 500;
    background: none;
    border: 1px solid transparent;
    color: var(--text-dim);
    width: 28px;
    height: 28px;
    border-radius: 4px;
    cursor: pointer;
    transition: all 0.15s;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .flag-btn:hover { background: var(--surface-2); color: var(--text); }
  .flag-btn.active {
    background: var(--accent-glow);
    color: var(--accent);
    border-color: var(--match-border);
  }

  .save-btn {
    font-family: var(--mono);
    font-size: 0.78rem;
    font-weight: 500;
    color: var(--accent);
    background: var(--accent-glow);
    border: 1px solid var(--match-border);
    border-radius: 6px;
    padding: 0 1rem;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
  }
  .save-btn:hover { background: rgba(91, 110, 239, 0.25); }

  /* ── Saved Patterns Panel ── */
  .saved-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    margin-bottom: 1.5rem;
    overflow: hidden;
  }

  .saved-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.6rem 1rem;
    background: var(--surface-2);
    cursor: pointer;
    user-select: none;
    transition: background 0.1s;
  }
  .saved-header:hover { background: var(--surface); }

  .saved-header-left {
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .saved-header .panel-title {
    font-family: var(--mono);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .saved-count {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--text-dim);
    background: var(--bg);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
  }

  .chevron {
    font-size: 0.7rem;
    color: var(--text-dim);
    transition: transform 0.2s;
  }
  .saved-panel.open .chevron { transform: rotate(180deg); }

  .saved-header-actions {
    display: flex;
    gap: 0.4rem;
  }

  .saved-body {
    display: none;
    border-top: 1px solid var(--border);
  }
  .saved-panel.open .saved-body { display: block; }

  .saved-list {
    max-height: 240px;
    overflow-y: auto;
  }

  .saved-list::-webkit-scrollbar { width: 6px; }
  .saved-list::-webkit-scrollbar-track { background: transparent; }
  .saved-list::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .saved-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.55rem 1rem;
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
    cursor: pointer;
  }
  .saved-item:last-child { border-bottom: none; }
  .saved-item:hover { background: var(--surface-2); }

  .saved-item-name {
    font-family: var(--sans);
    font-size: 0.82rem;
    color: var(--text);
    min-width: 100px;
    flex-shrink: 0;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .saved-item-pattern {
    font-family: var(--mono);
    font-size: 0.78rem;
    color: var(--text-dim);
    flex: 1;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .saved-item-flags {
    font-family: var(--mono);
    font-size: 0.68rem;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 0.1rem 0.35rem;
    border-radius: 3px;
    flex-shrink: 0;
  }

  .saved-item-actions {
    display: flex;
    gap: 0.25rem;
    flex-shrink: 0;
    opacity: 0;
    transition: opacity 0.12s;
  }
  .saved-item:hover .saved-item-actions { opacity: 1; }

  .icon-btn {
    font-size: 0.72rem;
    color: var(--text-dim);
    background: none;
    border: 1px solid transparent;
    border-radius: 3px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.12s;
  }
  .icon-btn:hover { color: var(--text); background: var(--surface); border-color: var(--border); }
  .icon-btn.danger:hover { color: var(--error); background: var(--error-bg); border-color: rgba(239,91,91,0.3); }

  .saved-empty {
    padding: 1.5rem 1rem;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.8rem;
    font-family: var(--mono);
  }

  .panel-action {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-dim);
    background: none;
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.2rem 0.5rem;
    cursor: pointer;
    transition: all 0.15s;
  }
  .panel-action:hover { color: var(--text); border-color: var(--text-dim); }

  /* ── Save Modal ── */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }

  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.5rem;
    width: 400px;
    max-width: 90vw;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
  }

  .modal h2 {
    font-family: var(--mono);
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 1rem;
  }

  .modal-field { margin-bottom: 1rem; }

  .modal-field label {
    display: block;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-bottom: 0.35rem;
  }

  .modal-field input {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.85rem;
    padding: 0.6rem 0.75rem;
    outline: none;
    transition: border-color 0.15s;
  }
  .modal-field input:focus { border-color: var(--border-focus); }

  .modal-preview {
    font-family: var(--mono);
    font-size: 0.8rem;
    color: var(--text-dim);
    background: var(--bg);
    padding: 0.5rem 0.75rem;
    border-radius: 5px;
    border: 1px solid var(--border);
    word-break: break-all;
  }

  .modal-btns {
    display: flex;
    gap: 0.5rem;
    justify-content: flex-end;
    margin-top: 1.25rem;
  }

  .modal-btn {
    font-family: var(--mono);
    font-size: 0.78rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 5px;
    cursor: pointer;
    border: 1px solid var(--border);
    transition: all 0.15s;
  }

  .modal-btn.cancel { background: none; color: var(--text-dim); }
  .modal-btn.cancel:hover { color: var(--text); border-color: var(--text-dim); }
  .modal-btn.primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .modal-btn.primary:hover { background: #4d5fdf; }

  /* ── Toast ── */
  .toast {
    position: fixed;
    bottom: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    font-family: var(--mono);
    font-size: 0.8rem;
    padding: 0.6rem 1.2rem;
    border-radius: 6px;
    opacity: 0;
    transition: all 0.3s;
    pointer-events: none;
    z-index: 200;
  }
  .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  .toast.success { background: var(--group-bg); color: #2dd48c; border: 1px solid var(--group-border); }
  .toast.warn { background: var(--warn-bg); color: var(--warn); border: 1px solid rgba(230,167,64,0.3); }
  .toast.error { background: var(--error-bg); color: var(--error); border: 1px solid rgba(239,91,91,0.3); }

  /* ── Main Grid ── */
  .main-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
    margin-bottom: 1.5rem;
  }

  .panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
  }

  .panel-title {
    font-family: var(--mono);
    font-size: 0.75rem;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  textarea {
    flex: 1;
    min-height: 300px;
    background: none;
    border: none;
    outline: none;
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.85rem;
    line-height: 1.7;
    padding: 1rem;
    resize: vertical;
  }

  textarea::placeholder { color: var(--text-dim); opacity: 0.4; }

  .highlighted-text {
    flex: 1;
    min-height: 300px;
    padding: 1rem;
    font-family: var(--mono);
    font-size: 0.85rem;
    line-height: 1.7;
    white-space: pre-wrap;
    word-break: break-word;
    overflow-y: auto;
  }

  .match-highlight {
    background: var(--match-bg);
    border-bottom: 2px solid var(--match-border);
    border-radius: 2px;
    padding: 1px 0;
  }

  /* ── Results ── */
  .results-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .results-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface-2);
  }

  .match-count {
    font-family: var(--mono);
    font-size: 0.75rem;
    color: var(--accent);
    background: var(--accent-glow);
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
  }

  .results-body {
    max-height: 350px;
    overflow-y: auto;
  }

  .results-body::-webkit-scrollbar { width: 6px; }
  .results-body::-webkit-scrollbar-track { background: transparent; }
  .results-body::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

  .match-item {
    padding: 0.6rem 1rem;
    border-bottom: 1px solid var(--border);
    display: grid;
    grid-template-columns: 40px 1fr;
    gap: 0.75rem;
    align-items: start;
    transition: background 0.1s;
  }

  .match-item:last-child { border-bottom: none; }
  .match-item:hover { background: var(--surface-2); }

  .match-index {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-dim);
    padding-top: 0.15rem;
  }

  .match-content {
    font-family: var(--mono);
    font-size: 0.85rem;
    color: var(--text);
    word-break: break-all;
  }

  .match-groups { margin-top: 0.35rem; display: flex; flex-wrap: wrap; gap: 0.35rem; }

  .group-tag {
    font-family: var(--mono);
    font-size: 0.72rem;
    background: var(--group-bg);
    border: 1px solid var(--group-border);
    color: #2dd48c;
    padding: 0.1rem 0.45rem;
    border-radius: 3px;
  }

  .group-label { color: var(--text-dim); margin-right: 0.2rem; }

  .empty-state {
    padding: 3rem 1rem;
    text-align: center;
    color: var(--text-dim);
    font-size: 0.85rem;
  }

  .empty-state .icon { font-size: 1.5rem; margin-bottom: 0.5rem; opacity: 0.4; }

  .error-msg {
    padding: 0.6rem 1rem;
    background: var(--error-bg);
    color: var(--error);
    font-family: var(--mono);
    font-size: 0.8rem;
    border-bottom: 1px solid rgba(239, 91, 91, 0.2);
  }

  .tab-bar { display: flex; gap: 0; }

  .tab-btn {
    font-family: var(--mono);
    font-size: 0.72rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text-dim);
    background: none;
    border: none;
    padding: 0.75rem 1rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.15s;
  }

  .tab-btn:hover { color: var(--text); }
  .tab-btn.active { color: var(--accent); border-bottom-color: var(--accent); }

  .view-table { width: 100%; border-collapse: collapse; }
  .view-table th {
    font-family: var(--mono);
    font-size: 0.7rem;
    font-weight: 500;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.06em;
    text-align: left;
    padding: 0.5rem 1rem;
    background: var(--surface-2);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
  }
  .view-table td {
    font-family: var(--mono);
    font-size: 0.82rem;
    padding: 0.45rem 1rem;
    border-bottom: 1px solid var(--border);
    color: var(--text);
    word-break: break-all;
  }
  .view-table tr:hover td { background: var(--surface-2); }

  @media (max-width: 768px) {
    body { padding: 1rem; }
    .main-grid { grid-template-columns: 1fr; }
    .regex-bar { flex-direction: column; }
    .saved-item-actions { opacity: 1; }
  }
</style>
</head>
<body>

<div class="container">
  <header>
    <h1>regex extractor</h1>
    <span class="tag">v1.1</span>
  </header>

  <!-- Regex Input Bar -->
  <div class="regex-bar">
    <div class="regex-input-wrap" id="regexWrap">
      <span class="regex-slash">/</span>
      <input type="text" id="regexInput" placeholder="enter regex pattern..." spellcheck="false" autocomplete="off">
      <span class="regex-slash">/</span>
      <div class="flags-wrap">
        <button class="flag-btn active" data-flag="g" title="global">g</button>
        <button class="flag-btn active" data-flag="i" title="case insensitive">i</button>
        <button class="flag-btn" data-flag="m" title="multiline">m</button>
        <button class="flag-btn" data-flag="s" title="dotAll">s</button>
      </div>
    </div>
    <button class="save-btn" id="savePatternBtn" title="Save current pattern">&#9733; Save</button>
  </div>

  <!-- Saved Patterns Panel -->
  <div class="saved-panel" id="savedPanel">
    <div class="saved-header" id="savedHeader">
      <div class="saved-header-left">
        <span class="panel-title">Saved Patterns</span>
        <span class="saved-count" id="savedCount">0</span>
        <span class="chevron">&#9660;</span>
      </div>
      <div class="saved-header-actions" onclick="event.stopPropagation()">
        <button class="panel-action" id="importBtn" title="Import from JSON file">Import</button>
        <button class="panel-action" id="exportBtn" title="Export to JSON file">Export</button>
      </div>
    </div>
    <div class="saved-body">
      <div class="saved-list" id="savedList"></div>
    </div>
  </div>

  <!-- Main Grid -->
  <div class="main-grid">
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Input Text</span>
        <button class="panel-action" id="clearBtn">Clear</button>
      </div>
      <textarea id="inputText" placeholder="Paste your text here..." spellcheck="false"></textarea>
    </div>
    <div class="panel">
      <div class="panel-header">
        <span class="panel-title">Highlighted</span>
      </div>
      <div class="highlighted-text" id="highlightedView"></div>
    </div>
  </div>

  <!-- Results -->
  <div class="results-panel">
    <div class="results-header">
      <div class="tab-bar">
        <button class="tab-btn active" data-tab="matches">Matches</button>
        <button class="tab-btn" data-tab="groups">Groups</button>
        <button class="tab-btn" data-tab="table">Table</button>
      </div>
      <div style="display:flex;align-items:center;gap:0.75rem;">
        <span class="match-count" id="matchCount">0 matches</span>
        <button class="panel-action" id="copyResults">Copy All</button>
      </div>
    </div>
    <div id="errorMsg" class="error-msg" style="display:none;"></div>
    <div class="results-body" id="resultsBody">
      <div class="empty-state">
        <div class="icon">&#8981;</div>
        Enter a regex pattern and paste text to extract matches
      </div>
    </div>
  </div>
</div>

<!-- Save Modal -->
<div class="modal-overlay" id="saveModal">
  <div class="modal">
    <h2 id="modalTitle">Save Pattern</h2>
    <div class="modal-field">
      <label>Name</label>
      <input type="text" id="patternName" placeholder="e.g. Email addresses" spellcheck="false">
    </div>
    <div class="modal-field">
      <label>Pattern</label>
      <div class="modal-preview" id="modalPreview"></div>
    </div>
    <div class="modal-btns">
      <button class="modal-btn cancel" id="modalCancel">Cancel</button>
      <button class="modal-btn primary" id="modalSave">Save</button>
    </div>
  </div>
</div>

<!-- Hidden file input -->
<input type="file" id="fileInput" accept=".json" style="display:none;">

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
  // ── DOM refs ──
  const regexInput = document.getElementById('regexInput');
  const inputText = document.getElementById('inputText');
  const highlightedView = document.getElementById('highlightedView');
  const resultsBody = document.getElementById('resultsBody');
  const matchCount = document.getElementById('matchCount');
  const errorMsg = document.getElementById('errorMsg');
  const regexWrap = document.getElementById('regexWrap');
  const flagBtns = document.querySelectorAll('.flag-btn');
  const tabBtns = document.querySelectorAll('.tab-btn');
  const clearBtn = document.getElementById('clearBtn');
  const copyResults = document.getElementById('copyResults');

  const savedPanel = document.getElementById('savedPanel');
  const savedHeader = document.getElementById('savedHeader');
  const savedList = document.getElementById('savedList');
  const savedCount = document.getElementById('savedCount');
  const savePatternBtn = document.getElementById('savePatternBtn');

  const saveModal = document.getElementById('saveModal');
  const modalTitle = document.getElementById('modalTitle');
  const patternName = document.getElementById('patternName');
  const modalPreview = document.getElementById('modalPreview');
  const modalCancel = document.getElementById('modalCancel');
  const modalSave = document.getElementById('modalSave');

  const importBtn = document.getElementById('importBtn');
  const exportBtn = document.getElementById('exportBtn');
  const fileInput = document.getElementById('fileInput');
  const toast = document.getElementById('toast');

  let currentMatches = [];
  let currentTab = 'matches';
  let savedPatterns = [];
  let editingIndex = -1;

  const STORAGE_KEY = 'regex-extractor-patterns';

  // ── Toast ──
  function showToast(msg, type = 'success') {
    toast.textContent = msg;
    toast.className = 'toast ' + type;
    requestAnimationFrame(() => toast.classList.add('show'));
    setTimeout(() => toast.classList.remove('show'), 2200);
  }

  // ── LocalStorage ──
  function loadPatterns() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      savedPatterns = raw ? JSON.parse(raw) : [];
    } catch { savedPatterns = []; }
    renderSavedList();
  }

  function savePatterns() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(savedPatterns));
    renderSavedList();
  }

  // ── Saved List Rendering ──
  function renderSavedList() {
    savedCount.textContent = savedPatterns.length;
    if (!savedPatterns.length) {
      savedList.innerHTML = '<div class="saved-empty">No saved patterns yet &#8212; save one with the &#9733; Save button above</div>';
      return;
    }
    savedList.innerHTML = savedPatterns.map((p, i) => `
      <div class="saved-item" data-idx="${i}" title="Click to load">
        <span class="saved-item-name">${escapeHtml(p.name)}</span>
        <span class="saved-item-pattern">/${escapeHtml(p.pattern)}/</span>
        <span class="saved-item-flags">${p.flags}</span>
        <div class="saved-item-actions">
          <button class="icon-btn" onclick="event.stopPropagation(); renamePattern(${i})" title="Rename">&#9998;</button>
          <button class="icon-btn danger" onclick="event.stopPropagation(); deletePattern(${i})" title="Delete">&#10005;</button>
        </div>
      </div>
    `).join('');

    savedList.querySelectorAll('.saved-item').forEach(el => {
      el.addEventListener('click', () => loadPattern(parseInt(el.dataset.idx)));
    });
  }

  function loadPattern(idx) {
    const p = savedPatterns[idx];
    regexInput.value = p.pattern;
    flagBtns.forEach(btn => {
      btn.classList.toggle('active', p.flags.includes(btn.dataset.flag));
    });
    run();
    showToast(`Loaded "${p.name}"`);
  }

  function deletePattern(idx) {
    const name = savedPatterns[idx].name;
    savedPatterns.splice(idx, 1);
    savePatterns();
    showToast(`Deleted "${name}"`, 'warn');
  }

  function renamePattern(idx) {
    editingIndex = idx;
    const p = savedPatterns[idx];
    modalTitle.textContent = 'Rename Pattern';
    patternName.value = p.name;
    modalPreview.textContent = `/${p.pattern}/${p.flags}`;
    modalSave.textContent = 'Rename';
    saveModal.classList.add('open');
    setTimeout(() => { patternName.focus(); patternName.select(); }, 50);
  }

  // ── Save Modal ──
  savePatternBtn.addEventListener('click', () => {
    const pattern = regexInput.value.trim();
    if (!pattern) { showToast('Enter a regex pattern first', 'warn'); return; }
    editingIndex = -1;
    modalTitle.textContent = 'Save Pattern';
    patternName.value = '';
    modalPreview.textContent = `/${pattern}/${getFlags()}`;
    modalSave.textContent = 'Save';
    saveModal.classList.add('open');
    setTimeout(() => patternName.focus(), 50);
  });

  modalCancel.addEventListener('click', () => saveModal.classList.remove('open'));
  saveModal.addEventListener('click', (e) => { if (e.target === saveModal) saveModal.classList.remove('open'); });

  modalSave.addEventListener('click', () => {
    const name = patternName.value.trim() || 'Untitled';
    if (editingIndex >= 0) {
      savedPatterns[editingIndex].name = name;
      savePatterns();
      showToast(`Renamed to "${name}"`);
    } else {
      savedPatterns.push({
        name,
        pattern: regexInput.value.trim(),
        flags: getFlags(),
        created: Date.now()
      });
      savePatterns();
      showToast(`Saved "${name}"`);
      if (!savedPanel.classList.contains('open')) savedPanel.classList.add('open');
    }
    saveModal.classList.remove('open');
  });

  patternName.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') modalSave.click();
    if (e.key === 'Escape') saveModal.classList.remove('open');
  });

  // ── Toggle Saved Panel ──
  savedHeader.addEventListener('click', () => savedPanel.classList.toggle('open'));

  // ── Import / Export ──
  exportBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    if (!savedPatterns.length) { showToast('No patterns to export', 'warn'); return; }
    const data = JSON.stringify(savedPatterns, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'regex-patterns.json';
    a.click();
    URL.revokeObjectURL(url);
    showToast(`Exported ${savedPatterns.length} pattern(s)`);
  });

  importBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    fileInput.click();
  });

  fileInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (!Array.isArray(data)) throw new Error('Not an array');
        const valid = data.filter(p => p && typeof p.pattern === 'string' && typeof p.flags === 'string');
        if (!valid.length) throw new Error('No valid patterns found');
        const existing = new Set(savedPatterns.map(p => p.pattern + '|' + p.flags));
        let added = 0;
        for (const p of valid) {
          const key = p.pattern + '|' + p.flags;
          if (!existing.has(key)) {
            savedPatterns.push({
              name: p.name || 'Imported',
              pattern: p.pattern,
              flags: p.flags,
              created: p.created || Date.now()
            });
            existing.add(key);
            added++;
          }
        }
        savePatterns();
        if (!savedPanel.classList.contains('open')) savedPanel.classList.add('open');
        const dupes = valid.length - added;
        showToast(`Imported ${added} new pattern(s)${dupes > 0 ? `, ${dupes} duplicate(s) skipped` : ''}`);
      } catch (err) {
        showToast('Invalid file: ' + err.message, 'error');
      }
    };
    reader.readAsText(file);
    fileInput.value = '';
  });

  // ── Flags ──
  flagBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      btn.classList.toggle('active');
      run();
    });
  });

  // ── Tabs ──
  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => {
      tabBtns.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      currentTab = btn.dataset.tab;
      renderResults();
    });
  });

  clearBtn.addEventListener('click', () => {
    inputText.value = '';
    run();
    inputText.focus();
  });

  // ── Copy ──
  function copyToClipboard(text) {
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.cssText = 'position:fixed;left:-9999px;top:-9999px;opacity:0;';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch(e) {}
    document.body.removeChild(ta);
  }

  copyResults.addEventListener('click', () => {
    if (!currentMatches.length) return;
    let text;
    if (currentTab === 'groups') {
      text = currentMatches.map((m, i) => {
        let line = `Match ${i + 1}: ${m[0]}`;
        const groups = m.slice(1).filter(g => g !== undefined);
        if (groups.length) line += `  \u2192  ${groups.join(' | ')}`;
        return line;
      }).join('\n');
    } else if (currentTab === 'table') {
      const maxGroups = Math.max(...currentMatches.map(m => m.length)) - 1;
      const header = ['#', 'Match', ...Array.from({length: maxGroups}, (_, i) => `$${i+1}`)].join('\t');
      const rows = currentMatches.map((m, i) => {
        const cols = [i+1, m[0], ...Array.from({length: maxGroups}, (_, g) => m[g+1] ?? '')];
        return cols.join('\t');
      });
      text = [header, ...rows].join('\n');
    } else {
      text = currentMatches.map(m => m[0]).join('\n');
    }
    copyToClipboard(text);
    copyResults.textContent = 'Copied!';
    setTimeout(() => copyResults.textContent = 'Copy All', 1200);
  });

  // ── Debounced Run ──
  let debounceTimer;
  regexInput.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(run, 120); });
  inputText.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(run, 120); });

  function getFlags() {
    return Array.from(flagBtns).filter(b => b.classList.contains('active')).map(b => b.dataset.flag).join('');
  }

  function escapeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  function run() {
    const pattern = regexInput.value;
    const text = inputText.value;

    errorMsg.style.display = 'none';
    regexWrap.classList.remove('error');
    currentMatches = [];

    if (!pattern || !text) {
      highlightedView.textContent = text || '';
      matchCount.textContent = '0 matches';
      renderResults();
      return;
    }

    let regex;
    try {
      regex = new RegExp(pattern, getFlags());
    } catch (e) {
      regexWrap.classList.add('error');
      errorMsg.textContent = e.message;
      errorMsg.style.display = 'block';
      highlightedView.textContent = text;
      matchCount.textContent = '0 matches';
      renderResults();
      return;
    }

    const isGlobal = regex.global;
    let matches = [];
    if (isGlobal) {
      let m, safety = 0;
      while ((m = regex.exec(text)) !== null && safety < 50000) {
        matches.push({ match: m, index: m.index });
        if (m[0].length === 0) regex.lastIndex++;
        safety++;
      }
    } else {
      const m = regex.exec(text);
      if (m) matches.push({ match: m, index: m.index });
    }

    currentMatches = matches.map(m => [...m.match]);
    matchCount.textContent = `${matches.length} match${matches.length !== 1 ? 'es' : ''}`;

    let html = '';
    let lastIdx = 0;
    for (const { match, index } of matches) {
      const end = index + match[0].length;
      html += escapeHtml(text.slice(lastIdx, index));
      html += `<span class="match-highlight">${escapeHtml(match[0])}</span>`;
      lastIdx = end;
    }
    html += escapeHtml(text.slice(lastIdx));
    highlightedView.innerHTML = html;

    renderResults();
  }

  function renderResults() {
    if (!currentMatches.length) {
      const hasInput = regexInput.value && inputText.value;
      resultsBody.innerHTML = `<div class="empty-state"><div class="icon">${hasInput ? '\u2205' : '\u2315'}</div>${hasInput ? 'No matches found' : 'Enter a regex pattern and paste text to extract matches'}</div>`;
      return;
    }
    if (currentTab === 'matches') renderMatchesList();
    else if (currentTab === 'groups') renderGroupsList();
    else if (currentTab === 'table') renderTable();
  }

  function renderMatchesList() {
    resultsBody.innerHTML = currentMatches.map((m, i) =>
      `<div class="match-item">
        <span class="match-index">${i + 1}</span>
        <span class="match-content">${escapeHtml(m[0])}</span>
      </div>`
    ).join('');
  }

  function renderGroupsList() {
    const hasGroups = currentMatches.some(m => m.length > 1);
    resultsBody.innerHTML = currentMatches.map((m, i) => {
      const groups = m.slice(1).filter(g => g !== undefined);
      return `<div class="match-item">
        <span class="match-index">${i + 1}</span>
        <div>
          <span class="match-content">${escapeHtml(m[0])}</span>
          ${groups.length ? `<div class="match-groups">${groups.map((g, gi) =>
            `<span class="group-tag"><span class="group-label">$${gi + 1}</span>${escapeHtml(g)}</span>`
          ).join('')}</div>` : ''}
        </div>
      </div>`;
    }).join('');
    if (!hasGroups) {
      resultsBody.innerHTML = `<div class="empty-state"><div class="icon">()</div>No capture groups in pattern \u2014 add parentheses to capture groups</div>`;
    }
  }

  function renderTable() {
    const maxGroups = Math.max(...currentMatches.map(m => m.length)) - 1;
    const groupCols = Array.from({ length: maxGroups }, (_, i) => i + 1);

    let html = `<table class="view-table"><thead><tr><th>#</th><th>Match</th>`;
    groupCols.forEach(g => html += `<th>$${g}</th>`);
    html += `</tr></thead><tbody>`;

    currentMatches.forEach((m, i) => {
      html += `<tr><td style="color:var(--text-dim)">${i + 1}</td><td>${escapeHtml(m[0])}</td>`;
      groupCols.forEach(g => html += `<td>${m[g] !== undefined ? escapeHtml(m[g]) : '<span style="color:var(--text-dim)">\u2014</span>'}</td>`);
      html += `</tr>`;
    });

    html += `</tbody></table>`;
    resultsBody.innerHTML = html;

    if (maxGroups === 0) {
      resultsBody.innerHTML = `<table class="view-table"><thead><tr><th>#</th><th>Match</th></tr></thead><tbody>` +
        currentMatches.map((m, i) => `<tr><td style="color:var(--text-dim)">${i + 1}</td><td>${escapeHtml(m[0])}</td></tr>`).join('') +
        `</tbody></table>`;
    }
  }

  // ── Init ──
  loadPatterns();
  run();
  regexInput.focus();
</script>

</body>
</html>
